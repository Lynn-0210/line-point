<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸Šç·šé›†é»æ›ç¦®ç‰©</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f4f7f9; color: #333; }
    .card { background: white; padding: 30px 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
    #photo { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #007bff; display: none; margin: 0 auto 15px; }
    #points { font-size: 64px; color: #007bff; font-weight: bold; margin: 10px 0; }
    .btn { padding: 15px; border: none; border-radius: 50px; font-size: 18px; width: 100%; cursor: pointer; font-weight: bold; margin-top: 15px; color: white; }
    #btnLogin { background-color: #007bff; }
    .btn-upload { background-color: #28a745; position: relative; }
    input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
    select { width: 100%; padding: 12px; font-size: 16px; border-radius: 10px; border: 2px solid #ddd; margin-bottom: 15px; }
    .hint { font-size: 13px; color: #666; background: #e9ecef; padding: 15px; border-radius: 10px; text-align: left; line-height: 1.6; }
    #status { margin-top: 20px; font-size: 14px; color: #17a2b8; font-weight: bold; }
    #preview { max-width: 100%; border-radius: 10px; margin-top: 15px; display: none; }
  </style>
</head>
<body>
  <div class="card">
    <h2 id="title">å­¸å“¡é›†é»ç³»çµ±</h2>
    <div id="loginArea">
        <button id="btnLogin" class="btn" onclick="liff.login()">LINE å¸³è™Ÿç™»å…¥</button>
    </div>
    <div id="memberArea" style="display:none;">
        <img id="photo" src="">
        <h2 id="name"></h2>
        <p style="margin:0; color:#888;">ç›®å‰ç´¯ç©ç©åˆ†</p>
        <div id="points">0</div>
        <select id="taskSelect" onchange="updatePointsDisplay()">
            <option value="event">ğŸ¢ å¯¦é«”èª²ç¨‹ç°½åˆ°</option>
            <option value="regular">ğŸ’» ç·šä¸Šå­¸ç¿’ç´€éŒ„</option>
        </select>
        <div class="hint">
          <b>ğŸŒŸ é›†é»è¦å‰‡ï¼š</b><br>
          1. æˆªåœ–éœ€åŒ…å«é—œéµå­—ï¼š<b>ä¸Šç·šé›†é»æ›ç¦®ç‰©</b><br>
          2. æˆªåœ–éœ€é¡¯ç¤º<b>ä»Šæ—¥æ—¥æœŸ</b>ã€‚<br>
          3. ç¶“ AI å¯©æ ¸é€šéå³å¯ç²å¾— 10 é»ï¼
        </div>
        <div class="btn btn-upload">
          ä¸Šå‚³æˆªåœ–é ˜ç©åˆ†
          <input type="file" accept="image/*" onchange="handleFile(this)">
        </div>
        <img id="preview" src="">
        <p id="status"></p>
    </div>
  </div>
  <script>
    // ğŸ”´ é€™è£¡ä¸€å®šè¦å¡«å¯«ä½ è‡ªå·±çš„ ID å’Œç¶²å€
    const MY_LIFF_ID = "https://liff.line.me/2008809788-bwJx5orN"; 
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwQWaRO_gqGdJgj649FxGXmSsuqdlAOZur7rRV5lWTzl8-XBgjqaoCVjHr8xF5vNDHcZQ/exec"; 

    let userProfile = null;
    let currentPointsData = { event: 0, regular: 0 };
    window.onload = async function() {
      try {
        await liff.init({ liffId: MY_LIFF_ID });
        if (liff.isLoggedIn()) {
          liff.getProfile().then(profile => {
            userProfile = profile;
            document.getElementById('loginArea').style.display = "none";
            document.getElementById('memberArea').style.display = "block";
            document.getElementById('name').innerText = profile.displayName;
            if(profile.pictureUrl) {
               document.getElementById('photo').src = profile.pictureUrl;
               document.getElementById('photo').style.display = "block";
            }
            refreshPoints();
          });
        }
      } catch (err) { console.error(err); }
    };
    function refreshPoints() {
      fetch(`${GAS_API_URL}?action=getPoints&userId=${userProfile.userId}`)
        .then(res => res.json())
        .then(data => {
            currentPointsData = data;
            updatePointsDisplay();
        });
    }
    function updatePointsDisplay() {
        const type = document.getElementById('taskSelect').value;
        document.getElementById('points').innerText = (type === 'event') ? currentPointsData.event : currentPointsData.regular;
    }
    function handleFile(input) {
      if (input.files && input.files[0]) {
        const status = document.getElementById('status');
        status.innerText = "ğŸš€ AI æ­£åœ¨æ ¸å°é—œéµå­—èˆ‡æ—¥æœŸ...";
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const maxWidth = 1000;
                const scale = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scale;
                canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                const base64 = canvas.toDataURL('image/jpeg', 0.8);
                document.getElementById('preview').src = base64;
                document.getElementById('preview').style.display = "block";
                upload(base64);
            }
        }
        reader.readAsDataURL(input.files[0]);
      }
    }
    function upload(base64) {
        fetch(GAS_API_URL, {
            method: 'POST',
            body: JSON.stringify({
                image: base64,
                userId: userProfile.userId,
                displayName: userProfile.displayName,
                category: document.getElementById('taskSelect').value
            })
        })
        .then(res => res.json())
        .then(res => {
            if (res.status === "SUCCESS") {
                alert("ğŸ‰ æ­å–œï¼å¯©æ ¸é€šéï¼Œç²å¾— " + res.added + " é»");
                currentPointsData = res.current;
                updatePointsDisplay();
                document.getElementById('status').innerText = "âœ… é ˜å–æˆåŠŸ";
            } else {
                alert("âŒ å¯©æ ¸å¤±æ•—ï¼š\n" + res.message);
                document.getElementById('status').innerText = "âŒ å¤±æ•—";
            }
        });
    }
  </script>
</body>
</html>
